<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Préstamos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }

    h1 {
      text-align: center;
    }

    .form-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
    }

    button {
      margin-top: 15px;
      padding: 10px 15px;
      background-color: #4CAF50;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    .resultados {
      margin-top: 20px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .registro {
      background: #e7f3e7;
      margin-bottom: 5px;
      padding: 5px;
      border-left: 5px solid #4CAF50;
    }

    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Registro de Préstamos</h1>

<div class="form-section">
  <label for="responsable">Responsable</label>
  <input type="text" id="responsable"/>

  <label for="alumno">Alumno</label>
  <input type="text" id="alumno"/>

  <label for="libro">Libro</label>
  <input type="text" id="libro"/>

  <label for="fecha">Fecha</label>
  <input type="date" id="fecha"/>

  <button onclick="registrarPrestamo()">Registrar Préstamo</button>
  <div class="error" id="errorRegistro"></div>
</div>

<div class="form-section">
  <h3>Buscar préstamo</h3>
  <label for="campo">Buscar por (Responsable, Alumno o Libro)</label>
  <input type="text" id="busqueda"/>
  <button onclick="buscarPrestamo()">Buscar</button>
  <div class="resultados" id="resultadosBusqueda"></div>
  <div class="error" id="errorBusqueda"></div>
</div>

<div class="form-section">
  <h3>Préstamos registrados en esta sesión</h3>
  <div class="resultados" id="prestamosSesion"></div>
</div>

<script>
  const SHEETS_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec';
  let prestamosSesion = [];

  function registrarPrestamo() {
    const responsable = document.getElementById("responsable").value.trim();
    const alumno = document.getElementById("alumno").value.trim();
    const libro = document.getElementById("libro").value.trim();
    const fecha = document.getElementById("fecha").value;

    if (!responsable || !alumno || !libro || !fecha) {
      document.getElementById("errorRegistro").textContent = "Por favor, completa todos los campos.";
      return;
    }

    document.getElementById("errorRegistro").textContent = "";

    const prestamo = { responsable, alumno, libro, fecha };

    fetch(SHEETS_WEBHOOK_URL, {
      method: "POST",
      body: JSON.stringify(prestamo),
      headers: {
        "Content-Type": "application/json",
      },
    })
    .then(res => res.json())
    .then(data => {
      if (data.result === "success") {
        prestamosSesion.push(prestamo);
        mostrarPrestamosSesion();
        limpiarFormulario();
      } else {
        document.getElementById("errorRegistro").textContent = "Error al registrar el préstamo.";
      }
    })
    .catch(() => {
      document.getElementById("errorRegistro").textContent = "Error al conectar con la base de datos.";
    });
  }

  function mostrarPrestamosSesion() {
    const contenedor = document.getElementById("prestamosSesion");
    contenedor.innerHTML = "";
    prestamosSesion.forEach(p => {
      const div = document.createElement("div");
      div.className = "registro";
      div.textContent = `${p.fecha} - ${p.responsable} prestó "${p.libro}" a ${p.alumno}`;
      contenedor.appendChild(div);
    });
  }

  function limpiarFormulario() {
    document.getElementById("responsable").value = "";
    document.getElementById("alumno").value = "";
    document.getElementById("libro").value = "";
    document.getElementById("fecha").value = "";
  }

  function buscarPrestamo() {
    const termino = document.getElementById("busqueda").value.trim().toLowerCase();
    if (!termino) return;

    fetch(SHEETS_WEBHOOK_URL)
      .then(res => res.json())
      .then(data => {
        const resultados = data.filter(p =>
          (p.Responsable || "").toLowerCase().includes(termino) ||
          (p.Alumno || "").toLowerCase().includes(termino) ||
          (p.Libro || "").toLowerCase().includes(termino)
        );

        mostrarResultadosBusqueda(resultados);
      })
      .catch(() => {
        document.getElementById("errorBusqueda").textContent = "Error al buscar en la base de datos.";
      });
  }

  function mostrarResultadosBusqueda(resultados) {
    const contenedor = document.getElementById("resultadosBusqueda");
    contenedor.innerHTML = "";
    document.getElementById("errorBusqueda").textContent = "";

    if (resultados.length === 0) {
      contenedor.textContent = "No se encontraron resultados.";
      return;
    }

    resultados.forEach(p => {
      const div = document.createElement("div");
      div.className = "registro";
      div.textContent = `${p.Fecha} - ${p.Responsable} prestó "${p.Libro}" a ${p.Alumno}`;
      contenedor.appendChild(div);
    });
  }
</script>

</body>
</html>

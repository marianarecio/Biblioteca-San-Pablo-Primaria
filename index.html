<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Biblioteca Primaria Colegio San Pablo</title>
  <link href="https://fonts.googleapis.com/css2?family=Jost&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Jost', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
      text-align: center;
    }

    h1 {
      background-color: #0c4a6e;
      color: white;
      margin: 0;
      padding: 20px 10px;
      font-size: 24px;
    }

    .contenedor {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .campo {
      margin: 10px 0;
      width: 100%;
      max-width: 400px;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #0c4a6e;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #08324d;
    }

    table {
      width: 100%;
      max-width: 600px;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
    }

    th {
      background-color: #0c4a6e;
      color: white;
    }

    .fila-devolucion {
      background-color: #e0f7fa !important;
      font-style: italic;
    }

    #scannerModal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }

    #scanner {
      width: 300px;
      height: 300px;
      background-color: white;
      padding: 10px;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <h1>Biblioteca Primaria Colegio San Pablo</h1>
  <div class="contenedor">
    <div class="campo">
      <label>Responsable:</label><br/>
      <input type="text" id="responsableInput" readonly onclick="startScanner('responsableInput')"/>
    </div>

    <div class="campo">
      <label>Alumno:</label><br/>
      <input type="text" id="alumnoInput" onclick="startScanner('alumnoInput')"/>
    </div>

    <div class="campo">
      <label>Libro:</label><br/>
      <input type="text" id="libroInput" onclick="startScanner('libroInput')"/>
    </div>

    <button onclick="registrarPrestamo()">Registrar Pr√©stamo</button>

    <h2>Pr√©stamos registrados</h2>
    <table>
      <thead>
        <tr>
          <th>Responsable</th>
          <th>Libro</th>
          <th>Alumno</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="prestamosTable"></tbody>
    </table>
  </div>

  <div id="scannerModal">
    <div id="scanner"></div>
  </div>

  <script>
    const SHEETS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec";
    let currentScanner = null;
    let responsableActual = "";
    let prestamosSesion = [];
    let prestamos = [];

    function guardarSesion() {
      sessionStorage.setItem("prestamosSesion", JSON.stringify(prestamosSesion));
    }

    function cargarSesion() {
      const data = sessionStorage.getItem("prestamosSesion");
      if (data) prestamosSesion = JSON.parse(data);

      const responsableGuardado = sessionStorage.getItem("responsableActual");
      if (responsableGuardado) {
        responsableActual = responsableGuardado;
        document.getElementById("responsableInput").value = responsableActual;
        document.getElementById("responsableInput").setAttribute("readonly", true);
      }

      actualizarTabla();
    }

    function registrarPrestamo() {
      const alumno = document.getElementById("alumnoInput").value.trim();
      const libro = document.getElementById("libroInput").value.trim();

      if (!responsableActual || !alumno || !libro) {
        alert("Faltan datos para registrar el pr√©stamo.");
        return;
      }

      const fecha = new Date().toLocaleString('es-AR', { hour: '2-digit', minute: '2-digit' });
      const fechaCompleta = new Date().toLocaleDateString('es-AR') + " " + fecha;

      const prestamo = {
        responsable: responsableActual,
        alumno,
        libro,
        fecha: fechaCompleta,
        tipo: "prestamo"
      };

      prestamosSesion.push(prestamo);
      prestamos.push(prestamo);
      guardarSesion();
      actualizarTabla();

      fetch(SHEETS_WEBHOOK_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(prestamo)
      });

      document.getElementById("libroInput").value = "";
      document.getElementById("alumnoInput").value = "";
    }

    function registrarDevolucion(alumno, libro) {
      const ahora = new Date();
      const fecha = ahora.toLocaleDateString('es-AR') + " " + ahora.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });

      const devolucion = {
        responsable: responsableActual,
        libro,
        alumno,
        fecha,
        tipo: "devolucion"
      };

      prestamosSesion.push(devolucion);
      prestamos.push(devolucion);
      guardarSesion();
      actualizarTabla();

      fetch(SHEETS_WEBHOOK_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(devolucion)
      });

      alert("¬°Devoluci√≥n registrada!");
    }

    function actualizarTabla() {
      const tabla = document.getElementById("prestamosTable");
      tabla.innerHTML = "";
      prestamosSesion.forEach(p => {
        const fila = tabla.insertRow();
        fila.insertCell(0).textContent = p.responsable;
        fila.insertCell(1).textContent = p.tipo === "devolucion" ? p.libro + " üì•" : p.libro;
        fila.insertCell(2).textContent = p.alumno;
        fila.insertCell(3).textContent = p.fecha;
        if (p.tipo === "devolucion") fila.classList.add("fila-devolucion");
      });
    }

    function stopScanner() {
      if (currentScanner) {
        currentScanner.stop().then(() => {
          document.getElementById("scannerModal").style.display = "none";
        });
      }
    }

    function startScanner(inputId) {
      if (currentScanner) {
        currentScanner.clear().then(() => {
          document.getElementById("scannerModal").style.display = "none";
        });
      }

      const scannerModal = document.getElementById("scannerModal");
      scannerModal.style.display = "flex";
      scannerModal.dataset.inputId = inputId;

      const scannerDiv = document.getElementById("scanner");
      scannerDiv.innerHTML = "";

      currentScanner = new Html5Qrcode("scanner");

      currentScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 280, height: 280 } },
        qrCodeMessage => {
          document.getElementById(inputId).value = qrCodeMessage;

          if (inputId === "responsableInput") {
            responsableActual = qrCodeMessage;
            sessionStorage.setItem("responsableActual", responsableActual);
            document.getElementById("responsableInput").setAttribute("readonly", true);
            stopScanner();
            return;
          }

          if (inputId === "alumnoInput") {
            stopScanner();
            const alumno = qrCodeMessage;
            document.getElementById("alumnoInput").value = alumno;

            // Aqu√≠ chequeamos si el alumno tiene pr√©stamo activo sin devoluci√≥n
            const prestamosActivos = prestamos.filter(p =>
              p.alumno === alumno &&
              p.tipo === "prestamo" &&
              !prestamos.some(d => d.tipo === "devolucion" && d.libro === p.libro && d.alumno === p.alumno)
            );

            if (prestamosActivos.length > 0) {
              alert("El alumno ya tiene un libro prestado. Escane√° ahora el libro que va a devolver.");

              // Forzamos a escanear devoluci√≥n
              setTimeout(() => {
                startScanner("libroInput");

                // Capturamos el siguiente escaneo para devoluci√≥n
                currentScanner.onScanSuccess = libroDevuelto => {
                  document.getElementById("libroInput").value = libroDevuelto;
                  stopScanner();
                  registrarDevolucion(alumno, libroDevuelto);

                  // Luego permitimos escanear el libro nuevo para pr√©stamo
                  setTimeout(() => startScanner("libroInput"), 800);
                };
              }, 500);
            } else {
              // Si no hay pr√©stamos activos, seguimos con pr√©stamo normal
              setTimeout(() => startScanner("libroInput"), 500);
            }
            return;
          }

          if (inputId === "libroInput") {
            stopScanner();
          }
        },
        errorMessage => {}
      ).catch(err => {
        alert("No se pudo acceder a la c√°mara");
        stopScanner();
      });
    }

    window.onload = cargarSesion;
  </script>
</body>
</html>

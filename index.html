<!DOCTYPE html>
<html lang="es">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Biblioteca Primaria Colegio San Pablo</title>
  <!-- Fuente Jost -->
  <link href="https://fonts.googleapis.com/css2?family=Jost&amp;display=swap" rel="stylesheet"/>
  <style>
   /* ... (aquí va todo tu CSS tal cual está en tu código, sin cambios) ... */
   body {
      font-family: 'Jost', sans-serif;
      background-color: #fff;
      color: #333;
      padding: 20px;
      text-align: center;
    }
    /* resto igual */
  </style>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
 </head>
 <body>
  <!-- Imagen escudo en el encabezado -->
  <img alt="Escudo Colegio San Pablo" id="top-image" src="https://csanpablo.edu.ar/wp-content/uploads/2022/07/escudo-centro-232x300.png"/>
  <h1>📚 Biblioteca Primaria Colegio San Pablo</h1>
  <p style="font-size:1em; color:#666; margin-bottom:14px;">
   Si est&aacute;s usando un celular, acepta el permiso de c&aacute;mara para escanear c&oacute;digos QR.
  </p>
  <p style="font-size: 1.3em; max-width: 98%; margin: 5px auto; line-height: 1.6;">
   Escane&aacute; primero el c&oacute;digo QR del
   <strong>alumno</strong>
   y luego el c&oacute;digo QR del
   <strong>libro</strong>
   para registrar un pr&eacute;stamo.
   <br/>
   Tambi&eacute;n pod&eacute;s buscar libros y ver qu&eacute; alumnos los tomaron, o buscar alumnos para ver qu&eacute; libros tienen en pr&eacute;stamo.
  </p>
  <div>
   <input id="responsableInput" placeholder="Escane&aacute; el QR del responsable" readonly type="text"/>
   <button onclick="startScanner('responsableInput')">📷</button>
   <input id="alumnoInput" placeholder="Escane&aacute; el QR del alumno" readonly type="text"/>
   <button onclick="startScanner('alumnoInput')">📷</button>
   <input id="libroInput" placeholder="Escane&aacute; el QR del libro" readonly type="text"/>
   <button onclick="startScanner('libroInput')">📷</button>
   <button onclick="registrarPrestamo()" style="background-color:#4a4e69;">Registrar Pr&eacute;stamo</button>
  </div>

  <h2 style="font-size: 2em; margin-top: 40px; margin-bottom: 20px;">📋 Pr&eacute;stamos Registrados</h2>
  <table>
   <thead>
    <tr>
     <th>Responsable</th>
     <th>Libro</th>
     <th>Alumno</th>
     <th>Fecha</th>
    </tr>
   </thead>
   <tbody id="prestamosTable"></tbody>
  </table>

  <div class="search-box">
   <h3>🔍 Buscar informaci&oacute;n</h3>
   <label class="search-label" for="buscarLibro">Buscar por libro</label>
   <input id="buscarLibro" placeholder="Ej: LIB001 o t&iacute;tulo" type="text"/>
   <button onclick="startScanner('buscarLibro')">📷</button>
   <button onclick="buscarPorLibro()">Buscar</button>
   <label class="search-label" for="buscarAlumno">Buscar por alumno</label>
   <input id="buscarAlumno" placeholder="Ej: ALU001 o nombre" type="text"/>
   <button onclick="startScanner('buscarAlumno')">📷</button>
   <button onclick="buscarPorAlumno()">Buscar</button>
  </div>
  <div id="resultadosBusqueda"></div>

  <!-- Modal con el escáner -->
  <div id="scannerModal">
    <div id="scanner"></div>
    <button id="closeScannerBtn" title="Cerrar escáner">×</button>
  </div>

  <script>
   // URL de tu Apps Script (cámbiala por la correcta)
   const SHEETS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwg-f66hkw2TIOCcIVxLQeawhze-fooBcHjEGyl2X6ghSZxUspo9yBpCFZP7jvew0VLuA/exec";

   let prestamos = [];

   // Cargar los préstamos desde Google Sheets al iniciar la página
   function cargarPrestamos() {
     fetch(SHEETS_WEBHOOK_URL)
       .then(response => response.json())
       .then(data => {
         prestamos = data;
         actualizarTabla();
       })
       .catch(err => {
         console.error("Error cargando préstamos:", err);
         alert("No se pudo cargar la lista de préstamos desde Google Sheets.");
       });
   }

   function registrarPrestamo() {
     const responsable = document.getElementById('responsableInput').value.trim();
     const libro = document.getElementById('libroInput').value.trim();
     const alumno = document.getElementById('alumnoInput').value.trim();
     if (!responsable || !libro || !alumno) {
       alert("Escaneá primero el libro y el alumno");
       return;
     }
     const fecha = new Date().toLocaleString();
     prestamos.push({ responsable, libro, alumno, fecha });
     actualizarTabla();
     document.getElementById('libroInput').value = "";
     document.getElementById('alumnoInput').value = "";

     // Enviar a Google Sheets
     fetch(SHEETS_WEBHOOK_URL, {
       method: 'POST',
       mode: 'no-cors',
       headers: {
         'Content-Type': 'application/json'
       },
       body: JSON.stringify({ responsable, libro, alumno, fecha })
     });

     alert("¡Préstamo registrado!");
   }

   function actualizarTabla() {
     const tabla = document.getElementById("prestamosTable");
     tabla.innerHTML = "";
     prestamos.forEach(p => {
       const fila = tabla.insertRow();
       fila.insertCell(0).textContent = p.responsable;
       fila.insertCell(1).textContent = p.libro;
       fila.insertCell(2).textContent = p.alumno;
       fila.insertCell(3).textContent = p.fecha;
     });
   }

   function buscarPorLibro() {
     const consulta = document.getElementById("buscarLibro").value.toLowerCase();
     const resultados = prestamos.filter(p => p.libro.toLowerCase().includes(consulta));
     mostrarResultados("Libro", consulta, resultados);
   }

   function buscarPorAlumno() {
     const consulta = document.getElementById("buscarAlumno").value.toLowerCase();
     const resultados = prestamos.filter(p => p.alumno.toLowerCase().includes(consulta));
     mostrarResultados("Alumno", consulta, resultados);
   }

   function mostrarResultados(tipo, consulta, resultados) {
     const contenedor = document.getElementById("resultadosBusqueda");
     if (!consulta) {
       contenedor.innerHTML = "";
       return;
     }
     if (resultados.length === 0) {
       contenedor.innerHTML = `<strong>No se encontraron resultados para ${tipo}: "${consulta}"</strong>`;
       return;
     }
     let html = `<strong>Resultados para ${tipo}: "${consulta}"</strong><ul>`;
     resultados.forEach(p => {
       html += `<li><strong>Libro:</strong> ${p.libro} | <strong>Alumno:</strong> ${p.alumno} | <strong>Fecha:</strong> ${p.fecha}</li>`;
     });
     html += "</ul>";
     contenedor.innerHTML = html;
   }

   // Variables para el escáner QR
   let currentScanner = null;

   function startScanner(inputId) {
     if (currentScanner) {
       currentScanner.clear().then(() => {
         document.getElementById("scannerModal").style.display = "none";
       });
     }
     const scannerModal = document.getElementById("scannerModal");
     scannerModal.style.display = "flex";
     scannerModal.dataset.inputId = inputId;
     const scannerDiv = document.getElementById("scanner");
     scannerDiv.innerHTML = "";
     currentScanner = new Html5Qrcode("scanner");
     currentScanner.start(
       { facingMode: "environment" },
       { fps: 10, qrbox: { width: 280, height: 280 } },
       qrCodeMessage => {
         document.getElementById(inputId).value = qrCodeMessage;
         stopScanner();
       },
       errorMessage => {
         //console.log("Error de escaneo:", errorMessage);
       }
     ).catch(err => {
       alert("No se pudo acceder a la cámara");
       stopScanner();
     });
   }

   function stopScanner() {
     if (currentScanner) {
       currentScanner.stop().then(() => {
         currentScanner.clear();
         currentScanner = null;
         document.getElementById("scannerModal").style.display = "none";
       }).catch((e) => {
         console.error("Error deteniendo el escáner:", e);
       });
     } else {
       document.getElementById("scannerModal").style.display = "none";
     }
   }

   // Botón cerrar modal
   document.getElementById("closeScannerBtn").addEventListener("click", stopScanner);

   // Cargar datos al iniciar la página
   window.onload = () => {
     cargarPrestamos();
   };
  </script>
 </body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Biblioteca - Colegio San Pablo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    #reader {
      width: 300px;
      margin: 10px auto;
    }
    .section {
      margin: 30px auto;
      max-width: 500px;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

  <h1>Biblioteca - Colegio San Pablo</h1>

  <div class="section" id="responsableSection">
    <h3>Escanear código del responsable</h3>
    <div id="reader" style="display: block;"></div>
  </div>

  <div class="section" id="registroSection" style="display: none;">
    <h3>Registrar préstamo</h3>
    <input type="text" id="alumno" placeholder="Alumno" readonly />
    <input type="text" id="libro" placeholder="Libro" readonly />
    <button onclick="resetear()">Cancelar</button>

    <h3>Préstamos registrados en esta sesión</h3>
    <table id="tablaPrestamos">
      <thead>
        <tr>
          <th>Responsable</th>
          <th>Alumno</th>
          <th>Libro</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h3>Buscar préstamo</h3>
    <input type="text" id="busqueda" placeholder="Buscar por alumno o libro" onkeypress="if(event.key === 'Enter') buscarPrestamo()" />
    <button onclick="buscarPrestamo()">Buscar</button>
    <table id="tablaBusqueda">
      <thead>
        <tr>
          <th>Responsable</th>
          <th>Alumno</th>
          <th>Libro</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const url = "https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec";

    let responsable = "";
    let alumno = "";
    let libro = "";
    let estado = "responsable"; // otros valores: 'alumno', 'libro'

    const html5QrCode = new Html5Qrcode("reader");

    function iniciarScanner() {
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess
          );
        } else {
          alert("No se encontró cámara.");
        }
      }).catch(err => {
        alert("Error accediendo a la cámara: " + err);
      });
    }

    function onScanSuccess(decodedText, decodedResult) {
      if (estado === "responsable") {
        responsable = decodedText;
        document.getElementById("responsableSection").style.display = "none";
        document.getElementById("registroSection").style.display = "block";
        estado = "alumno";
      } else if (estado === "alumno") {
        alumno = decodedText;
        document.getElementById("alumno").value = alumno;
        estado = "libro";
      } else if (estado === "libro") {
        libro = decodedText;
        document.getElementById("libro").value = libro;
        registrarPrestamo();
        estado = "alumno"; // Volver a esperar un nuevo alumno
        document.getElementById("alumno").value = "";
        document.getElementById("libro").value = "";
      }
    }

    function registrarPrestamo() {
      const fecha = new Date().toLocaleDateString("es-AR");
      fetch(url, {
        method: "POST",
        body: JSON.stringify({ responsable, alumno, libro, fecha }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.result === "success") {
          agregarFilaATabla("tablaPrestamos", { responsable, alumno, libro, fecha });
        } else {
          alert("Error al registrar préstamo.");
        }
      });
    }

    function agregarFilaATabla(idTabla, datos) {
      const tabla = document.getElementById(idTabla).getElementsByTagName("tbody")[0];
      const fila = tabla.insertRow();
      fila.insertCell(0).textContent = datos.responsable;
      fila.insertCell(1).textContent = datos.alumno;
      fila.insertCell(2).textContent = datos.libro;
      fila.insertCell(3).textContent = datos.fecha;
    }

    function buscarPrestamo() {
      const termino = document.getElementById("busqueda").value.toLowerCase();
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const resultados = data.filter(p =>
            (p.Alumno && p.Alumno.toLowerCase().includes(termino)) ||
            (p.Libro && p.Libro.toLowerCase().includes(termino))
          );
          const cuerpo = document.getElementById("tablaBusqueda").getElementsByTagName("tbody")[0];
          cuerpo.innerHTML = "";
          resultados.forEach(p => agregarFilaATabla("tablaBusqueda", {
            responsable: p.Responsable,
            alumno: p.Alumno,
            libro: p.Libro,
            fecha: p.Fecha
          }));
        })
        .catch(err => {
          alert("Error al buscar en la base de datos.");
        });
    }

    function resetear() {
      alumno = "";
      libro = "";
      estado = "alumno";
      document.getElementById("alumno").value = "";
      document.getElementById("libro").value = "";
    }

    window.onload = iniciarScanner;
  </script>

</body>
</html>

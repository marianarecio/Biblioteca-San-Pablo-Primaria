<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Biblioteca Colegio San Pablo</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fdf6e3;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #00274d;
      color: white;
      text-align: center;
      padding: 1em 0;
    }
    main {
      max-width: 600px;
      margin: 20px auto;
      padding: 1em;
      background-color: #fffaf0;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input[type="text"] {
      width: calc(100% - 110px);
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    button {
      padding: 8px 12px;
      margin-left: 5px;
      background-color: #00274d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #004080;
    }
    #scanner {
      width: 100%;
      margin-top: 15px;
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <header>
    <h1>Biblioteca Colegio San Pablo</h1>
  </header>
  <main>
    <section>
      <h2>Registrar PrÃ©stamo</h2>
      <label for="campoResponsable">Maestra:</label>
      <input type="text" id="campoResponsable" readonly>
      <button id="btnScanResponsable">ðŸ“·</button>

      <label for="campoAlumno">Alumno:</label>
      <input type="text" id="campoAlumno" readonly>
      <button id="btnScanAlumno">ðŸ“·</button>

      <label for="campoLibro">Libro:</label>
      <input type="text" id="campoLibro" readonly>
      <button id="btnScanLibro">ðŸ“·</button>

      <button id="btnRegistrar">Registrar</button>

      <div id="scanner"></div>
    </section>

    <section>
      <h2>PrÃ©stamos registrados</h2>
      <table id="tablaPrestamos">
        <thead>
          <tr>
            <th>Maestra</th>
            <th>Alumno</th>
            <th>Libro</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          <!-- filas dinÃ¡micas -->
        </tbody>
      </table>
    </section>

    <section>
      <h2>Buscar prÃ©stamos</h2>
      <input type="text" id="campoBusqueda" placeholder="Buscar por alumno o libro">
      <button id="btnBuscar">Buscar</button>
      <table id="tablaBusqueda">
        <thead>
          <tr>
            <th>Maestra</th>
            <th>Alumno</th>
            <th>Libro</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          <!-- resultados -->
        </tbody>
      </table>
    </section>
  </main>

  <script>
    let responsableActual = '';
    let alumnoActual = '';
    let html5QrcodeScanner;
    let isScanning = false;

    document.addEventListener('DOMContentLoaded', function () {
      const campoResponsable = document.getElementById("campoResponsable");
      const campoAlumno = document.getElementById("campoAlumno");
      const campoLibro = document.getElementById("campoLibro");

      // Escanear responsable una sola vez
      document.getElementById("btnScanResponsable").addEventListener("click", function () {
        iniciarEscaneo(function (texto) {
          campoResponsable.value = texto;
          responsableActual = texto;
        });
      });

      // Escanear alumno y dejar abierto para libro
      document.getElementById("btnScanAlumno").addEventListener("click", function () {
        iniciarEscaneo(function (texto) {
          campoAlumno.value = texto;
          alumnoActual = texto;
          escanearSiguienteLibro();
        });
      });

      // Escanear libro manual (opcional)
      document.getElementById("btnScanLibro").addEventListener("click", function () {
        iniciarEscaneo(function (texto) {
          campoLibro.value = texto;
          document.getElementById("btnRegistrar").click();
        });
      });

      function escanearSiguienteLibro() {
        iniciarEscaneo(function (texto) {
          campoLibro.value = texto;
          document.getElementById("btnRegistrar").click();
          detenerEscaneo();
        });
      }

      function iniciarEscaneo(callback) {
        if (isScanning) return;
        isScanning = true;

        const scanner = document.getElementById('scanner');
        scanner.style.display = 'block';

        html5QrcodeScanner = new Html5Qrcode("scanner");
        html5QrcodeScanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            callback(decodedText);
          },
          (errorMessage) => { }
        ).catch(err => {
          console.error("Error al iniciar escÃ¡ner:", err);
          isScanning = false;
        });
      }

      function detenerEscaneo() {
        if (html5QrcodeScanner) {
          html5QrcodeScanner.stop().then(() => {
            document.getElementById('scanner').style.display = 'none';
            isScanning = false;
          }).catch(err => {
            console.error("Error al detener escÃ¡ner:", err);
          });
        }
      }

      // Registrar prÃ©stamo
      document.getElementById("btnRegistrar").addEventListener("click", function () {
        const libro = campoLibro.value.trim();
        const alumno = campoAlumno.value.trim();
        const responsable = responsableActual;
        const fecha = new Date().toLocaleDateString();

        if (libro && alumno && responsable) {
          const datos = { libro, alumno, responsable, fecha };

          fetch('https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec', {
            method: 'POST',
            body: JSON.stringify(datos),
            headers: { 'Content-Type': 'application/json' }
          })
          .then(res => res.json())
          .then(response => {
            agregarFilaPrestamo(responsable, alumno, libro, fecha);
            campoAlumno.value = '';
            campoLibro.value = '';
          })
          .catch(err => alert("Error al registrar prÃ©stamo."));
        } else {
          alert("Faltan datos.");
        }
      });

      function agregarFilaPrestamo(responsable, alumno, libro, fecha) {
        const fila = document.createElement("tr");
        fila.innerHTML = `<td>${responsable}</td><td>${alumno}</td><td>${libro}</td><td>${fecha}</td>`;
        document.querySelector("#tablaPrestamos tbody").appendChild(fila);
      }

      // Buscar
      document.getElementById("btnBuscar").addEventListener("click", buscar);
      document.getElementById("campoBusqueda").addEventListener("keypress", function (e) {
        if (e.key === "Enter") buscar();
      });

      function buscar() {
        const termino = document.getElementById("campoBusqueda").value.trim().toLowerCase();
        if (!termino) return;

        fetch('https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec')
          .then(res => res.json())
          .then(datos => {
            const resultados = datos.filter(item =>
              item.Alumno.toLowerCase().includes(termino) ||
              item.Libro.toLowerCase().includes(termino)
            );
            mostrarResultados(resultados);
          })
          .catch(err => alert("Error al buscar en la base de datos."));
      }

      function mostrarResultados(resultados) {
        const tbody = document.querySelector("#tablaBusqueda tbody");
        tbody.innerHTML = "";
        resultados.forEach(item => {
          const fila = document.createElement("tr");
          fila.innerHTML = `<td>${item.Responsable}</td><td>${item.Alumno}</td><td>${item.Libro}</td><td>${item.Fecha}</td>`;
          tbody.appendChild(fila);
        });
      }
    });
  </script>
</body>
</html>

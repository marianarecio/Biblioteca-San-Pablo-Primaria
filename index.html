<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Biblioteca Escolar</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding-bottom: 100px;
    }
    h1 {
      text-align: center;
      color: #4a4a4a;
    }
    .scanner-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1000;
      display: none;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    button {
      padding: 10px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>Registro de Préstamos - Biblioteca Escolar</h1>

  <label>Responsable:</label>
  <input type="text" id="responsableInput" placeholder="Nombre del responsable" />
  <br><br>
  <button onclick="abrirScanner('libro')">Escanear Libro</button>
  <input type="text" id="libroInput" placeholder="Código del libro" readonly />
  <br><br>
  <button onclick="abrirScanner('alumno')">Escanear Alumno</button>
  <input type="text" id="alumnoInput" placeholder="Código del alumno" readonly />
  <br><br>
  <button onclick="registrarPrestamo()">Registrar Préstamo</button>

  <div class="overlay" id="overlay" onclick="cerrarScanner()"></div>
  <div class="scanner-container" id="scannerContainer">
    <div id="reader" style="width: 300px;"></div>
    <button onclick="cerrarScanner()">Cerrar</button>
  </div>

  <h2>Préstamos Registrados Hoy</h2>
  <table id="prestamosTable">
    <thead>
      <tr>
        <th>Responsable</th>
        <th>Alumno</th>
        <th>Libro</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const SHEETS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwg-f66hkw2TIOCcIVxLQeawhze-fooBcHjEGyl2X6ghSZxUspo9yBpCFZP7jvew0VLuA/exec";
    let scannerActivo = null;
    let inputActivo = null;
    const prestamos = [];

    function abrirScanner(campo) {
      inputActivo = campo;
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('scannerContainer').style.display = 'block';

      scannerActivo = new Html5Qrcode("reader");
      scannerActivo.start({ facingMode: "environment" }, {
        fps: 10,
        qrbox: 250
      }, qrCodeMessage => {
        if (inputActivo === 'libro') {
          document.getElementById('libroInput').value = qrCodeMessage;
        } else {
          document.getElementById('alumnoInput').value = qrCodeMessage;
        }
        cerrarScanner();
      }).catch(err => {
        alert("Error al iniciar la cámara: " + err);
        cerrarScanner();
      });
    }

    function cerrarScanner() {
      if (scannerActivo) {
        scannerActivo.stop().then(() => {
          scannerActivo.clear();
          scannerActivo = null;
        });
      }
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('scannerContainer').style.display = 'none';
    }

    function registrarPrestamo() {
      const responsable = document.getElementById('responsableInput').value.trim();
      const libro = document.getElementById('libroInput').value.trim();
      const alumno = document.getElementById('alumnoInput').value.trim();
      if (!responsable || !libro || !alumno) {
        alert("Escaneá primero el libro y el alumno");
        return;
      }
      const fecha = new Date().toLocaleString();
      prestamos.push({ responsable, libro, alumno, fecha });
      actualizarTabla();
      document.getElementById('libroInput').value = "";
      document.getElementById('alumnoInput').value = "";

      fetch(SHEETS_WEBHOOK_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ responsable, libro, alumno, fecha })
      });

      alert("¡Préstamo registrado!");
    }

    function actualizarTabla() {
      const hoy = new Date().toLocaleDateString();
      const tbody = document.querySelector("#prestamosTable tbody");
      tbody.innerHTML = "";
      prestamos.forEach(p => {
        if (new Date(p.fecha).toLocaleDateString() === hoy) {
          const fila = `<tr><td>${p.responsable}</td><td>${p.alumno}</td><td>${p.libro}</td><td>${p.fecha}</td></tr>`;
          tbody.innerHTML += fila;
        }
      });
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Biblioteca Primaria - Colegio San Pablo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    h1, h2, h3 {
      color: #4a4a4a;
    }
    .form-section, .search-box {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
    }
    input, select, button {
      padding: 10px;
      margin: 5px 0 15px 0;
      width: 100%;
      max-width: 400px;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: block;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #reader {
      width: 300px;
      margin: auto;
      display: none;
    }
    .search-label {
      margin-top: 10px;
      display: block;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h1>📚 Biblioteca Primaria - Colegio San Pablo</h1>

  <div class="form-section">
    <h2>Registrar préstamo</h2>
    <label for="responsable">Responsable</label>
    <input type="text" id="responsable" placeholder="Nombre del responsable"/>

    <label for="alumno">Alumno</label>
    <input type="text" id="alumno" placeholder="Nombre o código del alumno"/>
    <button onclick="startScanner('alumno')">📷 Escanear alumno</button>

    <label for="libro">Libro</label>
    <input type="text" id="libro" placeholder="Título o código del libro"/>
    <button onclick="startScanner('libro')">📷 Escanear libro</button>

    <button onclick="registrarPrestamo()">Registrar préstamo</button>
  </div>

  <div id="reader"></div>

  <div class="form-section">
    <h2>Préstamos registrados (solo esta sesión)</h2>
    <table id="tablaPrestamos">
      <thead>
        <tr>
          <th>Responsable</th>
          <th>Alumno</th>
          <th>Libro</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="search-box">
    <h3>🔍 Buscar información</h3>
    <label class="search-label" for="buscarGeneral">Buscar por libro o alumno</label>
    <input id="buscarGeneral" placeholder="Ej: nombre o código de libro o alumno" type="text" onkeydown="if(event.key === 'Enter'){ buscarGeneral(); }"/>
    <button onclick="buscarGeneral()">Buscar</button>
  </div>
  <div id="resultadosBusqueda"></div>

  <script>
    const SHEETS_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec';
    let prestamos = [];

    function registrarPrestamo() {
      const responsable = document.getElementById('responsable').value;
      const alumno = document.getElementById('alumno').value;
      const libro = document.getElementById('libro').value;
      const fecha = new Date().toLocaleDateString('es-AR');

      if (!responsable || !alumno || !libro) {
        alert('Por favor, completá todos los campos');
        return;
      }

      const datos = { responsable, alumno, libro, fecha };

      fetch(SHEETS_WEBHOOK_URL, {
        method: 'POST',
        body: JSON.stringify(datos),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(r => r.text())
      .then(res => {
        agregarAFila(datos);
        prestamos.push(datos);
        document.getElementById('responsable').value = '';
        document.getElementById('alumno').value = '';
        document.getElementById('libro').value = '';
      });
    }

    function agregarAFila(p) {
      const tabla = document.getElementById('tablaPrestamos').getElementsByTagName('tbody')[0];
      const fila = tabla.insertRow();
      fila.insertCell(0).innerText = p.responsable;
      fila.insertCell(1).innerText = p.alumno;
      fila.insertCell(2).innerText = p.libro;
      fila.insertCell(3).innerText = p.fecha;
    }

    function buscarGeneral() {
      const consulta = document.getElementById("buscarGeneral").value.trim().toLowerCase();
      if (!prestamos.length) {
        // Si prestamos está vacío, consultamos la base
        fetch(SHEETS_WEBHOOK_URL)
          .then(response => response.json())
          .then(data => {
            prestamos = data;
            filtrarYMostrar(consulta);
          })
          .catch(err => {
            console.error(err);
            alert("Error al buscar en la base de datos.");
          });
      } else {
        filtrarYMostrar(consulta);
      }
    }

    function filtrarYMostrar(consulta) {
      const resultados = prestamos.filter(p =>
        p.libro.toLowerCase().includes(consulta) ||
        p.alumno.toLowerCase().includes(consulta)
      );
      mostrarResultados("Consulta", consulta, resultados);
    }

    function mostrarResultados(tipo, valor, resultados) {
      const contenedor = document.getElementById("resultadosBusqueda");
      if (resultados.length === 0) {
        contenedor.innerHTML = `<p>No se encontraron resultados para "${valor}".</p>`;
        return;
      }
      let html = `<h3>Resultados para "${valor}":</h3>`;
      html += `<table><thead><tr><th>Responsable</th><th>Alumno</th><th>Libro</th><th>Fecha</th></tr></thead><tbody>`;
      resultados.forEach(p => {
        html += `<tr><td>${p.responsable}</td><td>${p.alumno}</td><td>${p.libro}</td><td>${p.fecha}</td></tr>`;
      });
      html += `</tbody></table>`;
      contenedor.innerHTML = html;
    }

    function startScanner(campoId) {
      const reader = document.getElementById('reader');
      reader.style.display = 'block';
      const html5QrCode = new Html5Qrcode("reader");

      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          const cameraId = devices[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              document.getElementById(campoId).value = qrCodeMessage;
              html5QrCode.stop().then(() => {
                reader.style.display = 'none';
              });
            },
            errorMessage => {}
          );
        }
      }).catch(err => {
        console.error(err);
      });
    }
  </script>
</body>
</html>

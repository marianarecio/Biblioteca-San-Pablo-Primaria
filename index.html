<!DOCTYPE html>
<html lang="es">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Biblioteca Primaria Colegio San Pablo</title>
  <!-- Fuente Jost -->
  <link href="https://fonts.googleapis.com/css2?family=Jost&display=swap" rel="stylesheet"/>
  <style>
   body {
    font-family: 'Jost', sans-serif;
    background-color: #f4f4f9;
    margin: 0;
    padding: 20px;
    text-align: center;
   }

   h1 {
    color: #333;
    margin-bottom: 20px;
   }

   #reader {
    width: 300px;
    margin: 0 auto 20px auto;
   }

   input[type="text"] {
    padding: 10px;
    width: 80%;
    max-width: 400px;
    margin: 10px auto;
    display: block;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
   }

   button {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    background-color: #4a4e69;
    color: white;
    cursor: pointer;
    margin: 10px 5px;
   }

   button:hover {
    background-color: #6c70a3;
   }

   table {
    width: 90%;
    margin: 20px auto;
    border-collapse: collapse;
   }

   th, td {
    border: 1px solid #ddd;
    padding: 8px;
    font-size: 14px;
   }

   th {
    background-color: #4a4e69;
    color: white;
   }

   tr:nth-child(even) {
    background-color: #f2f2f2;
   }

   .scanner-placeholder {
    padding: 10px;
    width: 80%;
    max-width: 400px;
    margin: 10px auto 20px auto;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    color: #666;
    cursor: pointer;
    user-select: none;
    background-color: #fafafa;
    transition: background-color 0.3s ease;
   }

   .scanner-placeholder:hover,
   .scanner-placeholder:focus {
    background-color: #e3e9ff;
    outline: none;
    color: #4a4e69;
   }
  </style>
 </head>
 <body>
  <h1>Biblioteca Primaria Colegio San Pablo</h1>

  <div>
   <input id="responsableInput" placeholder="Escane√° tu QR (responsable)" readonly type="text"/>
   <button onclick="startScanner('responsableInput')">üì∑</button>
  </div>

  <div>
   <div id="alumnoInput" class="scanner-placeholder" tabindex="0" role="button" aria-label="Escanear QR del alumno" onclick="startScanner('alumnoInput')" onkeydown="if(event.key==='Enter'){startScanner('alumnoInput')}">
    Escane√° el QR del alumno
   </div>
  </div>

  <div>
   <div id="libroInput" class="scanner-placeholder" tabindex="0" role="button" aria-label="Escanear QR del libro" onclick="startScanner('libroInput')" onkeydown="if(event.key==='Enter'){startScanner('libroInput')}">
    Escane√° el QR del libro
   </div>
  </div>

  <button onclick="registrarPrestamo()">Registrar Pr√©stamo</button>

  <h2>Pr√©stamos registrados hoy</h2>
  <table id="prestamosTable">
   <thead>
    <tr>
     <th>Responsable</th>
     <th>Alumno</th>
     <th>Libro</th>
     <th>Fecha</th>
    </tr>
   </thead>
   <tbody></tbody>
  </table>

  <h2>Buscar pr√©stamos</h2>
  <input id="buscarInput" placeholder="Buscar por alumno o libro" type="text" onkeypress="if(event.key==='Enter'){buscar()}"/>
  <button onclick="buscar()">Buscar</button>
  <table id="resultadosBusqueda" style="display:none;">
   <thead>
    <tr>
     <th>Responsable</th>
     <th>Alumno</th>
     <th>Libro</th>
     <th>Fecha</th>
    </tr>
   </thead>
   <tbody></tbody>
  </table>

  <div id="reader" style="display:none;"></div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
   let scanner;
   let currentInputId = "";

   function startScanner(inputId) {
    currentInputId = inputId;
    document.getElementById("reader").style.display = "block";
    scanner = new Html5Qrcode("reader");
    scanner.start(
     { facingMode: "environment" },
     {
      fps: 10,
      qrbox: 250
     },
     qrCodeMessage => {
      const elem = document.getElementById(inputId);
      if(inputId === "alumnoInput" || inputId === "libroInput") {
        elem.textContent = qrCodeMessage;
      } else {
        elem.value = qrCodeMessage;
      }
      scanner.stop().then(() => {
       document.getElementById("reader").style.display = "none";
      });
     },
     errorMessage => {}
    ).catch(err => {
     console.error("Error starting scanner:", err);
    });
   }

   function registrarPrestamo() {
    const responsable = document.getElementById("responsableInput").value.trim();
    const alumno = document.getElementById("alumnoInput").textContent.trim();
    const libro = document.getElementById("libroInput").textContent.trim();
    const fecha = new Date();
    const fechaFormateada = fecha.toLocaleDateString('es-AR') + " " + fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });

    if (!responsable || !alumno || !libro) {
     alert("Todos los campos deben estar completos.");
     return;
    }

    fetch("https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec", {
     method: "POST",
     mode: "no-cors",
     headers: {
      "Content-Type": "application/json"
     },
     body: JSON.stringify({ responsable, alumno, libro, fecha: fechaFormateada })
    });

    const fila = `<tr><td>${responsable}</td><td>${alumno}</td><td>${libro}</td><td>${fechaFormateada}</td></tr>`;
    document.querySelector("#prestamosTable tbody").innerHTML += fila;

    const hoy = new Date().toLocaleDateString('es-AR');
    const prestamosHoy = JSON.parse(sessionStorage.getItem("prestamosHoy") || "[]");
    prestamosHoy.push({ responsable, alumno, libro, fecha: fechaFormateada });
    sessionStorage.setItem("prestamosHoy", JSON.stringify(prestamosHoy));

    document.getElementById("libroInput").textContent = "Escane√° el QR del libro";
    document.getElementById("alumnoInput").textContent = "Escane√° el QR del alumno";
   }

   function buscar() {
    const query = document.getElementById("buscarInput").value.trim().toLowerCase();
    if (!query) return;

    fetch("https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec")
     .then(res => res.json())
     .then(data => {
      const resultados = data.filter(item =>
       item.Alumno.toLowerCase().includes(query) ||
       item.Libro.toLowerCase().includes(query)
      );

      const tbody = document.querySelector("#resultadosBusqueda tbody");
      tbody.innerHTML = "";
      resultados.forEach(p => {
       const fila = `<tr><td>${p.Responsable}</td><td>${p.Alumno}</td><td>${p.Libro}</td><td>${p.Fecha}</td></tr>`;
       tbody.innerHTML += fila;
      });

      document.getElementById("resultadosBusqueda").style.display = resultados.length ? "table" : "none";
     });
   }

   window.onload = () => {
    const prestamosHoy = JSON.parse(sessionStorage.getItem("prestamosHoy") || "[]");
    const hoy = new Date().toLocaleDateString('es-AR');
    const tbody = document.querySelector("#prestamosTable tbody");
    prestamosHoy.forEach(p => {
     if (p.fecha.startsWith(hoy)) {
      const fila = `<tr><td>${p.responsable}</td><td>${p.alumno}</td><td>${p.libro}</td><td>${p.fecha}</td></tr>`;
      tbody.innerHTML += fila;
     }
    });
   };
  </script>
 </body>
</html>

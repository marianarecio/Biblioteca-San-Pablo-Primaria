<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Biblioteca Escolar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background-color: #f9f9f9;
    }

    h1 {
      text-align: center;
    }

    label {
      font-weight: bold;
    }

    input, button, select {
      padding: 8px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
    }

    .registro, .busqueda {
      background-color: #fff;
      padding: 16px;
      margin-top: 24px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #eee;
    }

    .button-group {
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>

  <h1>Registro de Préstamos</h1>

  <div class="registro">
    <h2>Nuevo Préstamo</h2>
    <label>Responsable:</label>
    <input type="text" id="responsable" placeholder="Nombre del responsable" />

    <label>Alumno:</label>
    <input type="text" id="alumno" placeholder="Nombre del alumno" />

    <label>Libro:</label>
    <input type="text" id="libro" placeholder="Nombre del libro" />

    <button onclick="registrarPrestamo()">Registrar Préstamo</button>

    <h3>Préstamos Registrados (en esta sesión)</h3>
    <table id="tablaPrestamos">
      <thead>
        <tr>
          <th>Responsable</th>
          <th>Alumno</th>
          <th>Libro</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="prestamosBody"></tbody>
    </table>
  </div>

  <div class="busqueda">
    <h2>Búsqueda en la Base de Datos</h2>

    <label>Búsqueda por alumno o libro:</label>
    <input type="text" id="busquedaUnica" placeholder="Nombre del alumno o del libro" />

    <button onclick="buscar()">Buscar</button>

    <table id="tablaResultados" style="display:none;">
      <thead>
        <tr>
          <th>Responsable</th>
          <th>Alumno</th>
          <th>Libro</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="resultadosBody"></tbody>
    </table>
  </div>

  <script>
    const SHEETS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec";
    let prestamosSesion = [];

    function registrarPrestamo() {
      const responsable = document.getElementById('responsable').value.trim();
      const alumno = document.getElementById('alumno').value.trim();
      const libro = document.getElementById('libro').value.trim();
      const fecha = new Date().toLocaleString('es-AR');

      if (!responsable || !alumno || !libro) {
        alert('Por favor, completá todos los campos.');
        return;
      }

      const prestamo = { responsable, alumno, libro, fecha };

      fetch(SHEETS_WEBHOOK_URL, {
        method: 'POST',
        body: JSON.stringify(prestamo),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        if (data.result === "success") {
          prestamosSesion.push(prestamo);
          mostrarPrestamosSesion();
          document.getElementById('responsable').value = '';
          document.getElementById('alumno').value = '';
          document.getElementById('libro').value = '';
        } else {
          alert("Error al registrar el préstamo.");
        }
      })
      .catch(error => {
        alert("Error al conectar con el servidor.");
        console.error(error);
      });
    }

    function mostrarPrestamosSesion() {
      const cuerpo = document.getElementById('prestamosBody');
      cuerpo.innerHTML = "";
      prestamosSesion.forEach(p => {
        const fila = `<tr>
          <td>${p.responsable}</td>
          <td>${p.alumno}</td>
          <td>${p.libro}</td>
          <td>${p.fecha}</td>
        </tr>`;
        cuerpo.innerHTML += fila;
      });
    }

    function buscar() {
      const termino = document.getElementById("busquedaUnica").value.trim().toLowerCase();

      if (!termino) return;

      fetch(SHEETS_WEBHOOK_URL)
        .then(response => response.json())
        .then(data => {
          const resultados = data.filter(p =>
            (p.alumno && p.alumno.toLowerCase().includes(termino)) ||
            (p.libro && p.libro.toLowerCase().includes(termino))
          );

          const cuerpo = document.getElementById("resultadosBody");
          cuerpo.innerHTML = "";

          if (resultados.length > 0) {
            resultados.forEach(p => {
              const fila = `<tr>
                <td>${p.responsable}</td>
                <td>${p.alumno}</td>
                <td>${p.libro}</td>
                <td>${p.fecha}</td>
              </tr>`;
              cuerpo.innerHTML += fila;
            });
            document.getElementById("tablaResultados").style.display = "table";
          } else {
            document.getElementById("tablaResultados").style.display = "none";
            alert("No se encontraron resultados.");
          }
        })
        .catch(error => {
          alert("Error al buscar en la base de datos.");
          console.error(error);
        });
    }

    // Activar búsqueda con tecla Enter
    document.getElementById("busquedaUnica").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        buscar();
      }
    });
  </script>

</body>
</html>

<script>
  let responsableActual = localStorage.getItem("responsable") || "";
  let prestamos = JSON.parse(localStorage.getItem("prestamos")) || [];
  let prestamosSesion = [];

  const SHEETS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec";

  function iniciarScanner(campoId) {
    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: 250 };

    html5QrCode.start(
      { facingMode: "environment" },
      config,
      (decodedText, decodedResult) => {
        document.getElementById(campoId).value = decodedText;
        html5QrCode.stop().then(() => {
          document.getElementById("reader").innerHTML = "";
        }).catch((err) => console.error("Error al detener el escáner:", err));
      },
      (errorMessage) => {
        // Ignorar errores de escaneo por ahora
      }
    ).catch((err) => console.error("Error al iniciar el escáner:", err));
  }

  function registrarPrestamo() {
    if(!responsableActual) {
      alert("Primero escaneá el código QR del responsable para iniciar sesión.");
      return;
    }
    const libro = document.getElementById('libroInput').value.trim();
    const alumno = document.getElementById('alumnoInput').value.trim();
    if (!libro || !alumno) {
      alert("Escaneá primero el código QR del alumno y del libro");
      return;
    }
    const ahora = new Date();
    const fecha = ahora.toLocaleDateString('es-AR') + " " + ahora.toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'});

    const nuevoPrestamo = { responsable: responsableActual, libro, alumno, fecha };

    prestamosSesion.push(nuevoPrestamo);
    prestamos.push(nuevoPrestamo);
    guardarSesion();
    actualizarTabla();

    document.getElementById('libroInput').value = "";
    document.getElementById('alumnoInput').value = "";

    fetch(SHEETS_WEBHOOK_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(nuevoPrestamo)
    });

    alert("¡Préstamo registrado!");
  }

  function buscar() {
    const busqueda = document.getElementById("busqueda").value.toLowerCase();
    const resultados = prestamos.filter(p =>
      p.alumno.toLowerCase().includes(busqueda) ||
      p.libro.toLowerCase().includes(busqueda)
    );

    const tabla = document.getElementById("tablaResultados");
    tabla.innerHTML = `
      <tr>
        <th>Responsable</th>
        <th>Alumno</th>
        <th>Libro</th>
        <th>Fecha</th>
      </tr>
    `;

    resultados.forEach(p => {
      const fila = tabla.insertRow(-1);
      fila.innerHTML = `
        <td>${p.responsable}</td>
        <td>${p.alumno}</td>
        <td>${p.libro}</td>
        <td>${p.fecha}</td>
      `;
    });
  }

  function guardarSesion() {
    localStorage.setItem("responsable", responsableActual);
    localStorage.setItem("prestamos", JSON.stringify(prestamos));
  }

  function actualizarTabla() {
    const tabla = document.getElementById("tablaPrestamos");
    tabla.innerHTML = `
      <tr>
        <th>Responsable</th>
        <th>Alumno</th>
        <th>Libro</th>
        <th>Fecha</th>
      </tr>
    `;
    prestamosSesion.forEach(p => {
      const fila = tabla.insertRow(-1);
      fila.innerHTML = `
        <td>${p.responsable}</td>
        <td>${p.alumno}</td>
        <td>${p.libro}</td>
        <td>${p.fecha}</td>
      `;
    });
  }

  window.onload = function () {
    if (responsableActual) {
      document.getElementById("nombreResponsable").textContent = responsableActual;
    }

    // Escáner con Enter en búsqueda
    document.getElementById("busqueda").addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        buscar();
      }
    });

    // Activar escáner al hacer clic en el input de Alumno
    document.getElementById("alumnoInput").addEventListener("click", function() {
      iniciarScanner('alumnoInput');
    });

    // Activar escáner al hacer clic en el input de Libro
    document.getElementById("libroInput").addEventListener("click", function() {
      iniciarScanner('libroInput');
    });

    actualizarTabla();
  }
</script>

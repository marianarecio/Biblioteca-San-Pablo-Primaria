<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Biblioteca San Pablo</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f4f4f4;
    }

    h1 {
      text-align: center;
    }

    .form-container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
    }

    .form-container div {
      margin-bottom: 15px;
    }

    input[type="text"] {
      width: calc(100% - 20px);
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      padding: 10px 15px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #004c99;
    }

    #reader {
      width: 100%;
      margin: auto;
      padding: 10px;
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .search-section {
      text-align: center;
      margin-top: 40px;
    }

    .search-section input {
      padding: 10px;
      width: 60%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .search-section button {
      padding: 10px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>Biblioteca Primaria - Colegio San Pablo</h1>
  <div class="form-container">
    <div>
      <input id="responsableInput" placeholder="Escaneá el QR del responsable" readonly type="text" onclick="startScanner('responsableInput')"/>
    </div>
    <div>
      <input id="alumnoInput" placeholder="Escaneá el QR del alumno" readonly type="text" onclick="startScanner('alumnoInput')"/>
    </div>
    <div>
      <input id="libroInput" placeholder="Escaneá el QR del libro" readonly type="text" onclick="startScanner('libroInput')"/>
    </div>
    <div>
      <button onclick="registrarPrestamo()">Registrar Préstamo</button>
    </div>
    <div id="reader"></div>
  </div>

  <div class="search-section">
    <h2>Buscar Préstamos</h2>
    <input type="text" id="buscarInput" placeholder="Buscar por alumno o libro..." onkeydown="if(event.key==='Enter') buscarPrestamos()">
    <button onclick="buscarPrestamos()">Buscar</button>
    <div>
      <table id="tablaResultados">
        <thead>
          <tr>
            <th>Responsable</th>
            <th>Alumno</th>
            <th>Libro</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="search-section">
    <h2>Préstamos Registrados Hoy</h2>
    <table id="tablaPrestamos">
      <thead>
        <tr>
          <th>Responsable</th>
          <th>Alumno</th>
          <th>Libro</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let responsableActual = "";

    function startScanner(inputId) {
      const input = document.getElementById(inputId);
      const reader = document.getElementById("reader");
      reader.style.display = "block";

      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        qrCodeMessage => {
          input.value = qrCodeMessage;

          if (inputId === "responsableInput") {
            responsableActual = qrCodeMessage;
            sessionStorage.setItem("responsableActual", responsableActual);
            input.setAttribute("readonly", true);
            input.onclick = null;
          }

          html5QrCode.stop().then(() => {
            reader.style.display = "none";
          });
        },
        errorMessage => {}
      ).catch(err => {
        console.error("Error al iniciar el escáner:", err);
      });
    }

    function registrarPrestamo() {
      const alumno = document.getElementById("alumnoInput").value;
      const libro = document.getElementById("libroInput").value;

      if (!responsableActual || !alumno || !libro) {
        alert("Faltan datos para registrar el préstamo.");
        return;
      }

      const fecha = new Date().toLocaleString("es-AR");
      const prestamo = { responsable: responsableActual, alumno, libro, fecha };

      guardarPrestamoEnSheets(prestamo);
      guardarPrestamoEnSesion(prestamo);
      mostrarPrestamosRegistrados();

      document.getElementById("alumnoInput").value = "";
      document.getElementById("libroInput").value = "";
    }

    function guardarPrestamoEnSheets(prestamo) {
      const url = "https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec";
      fetch(url, {
        method: "POST",
        body: JSON.stringify(prestamo),
        headers: {
          "Content-Type": "application/json"
        }
      }).catch(error => console.error("Error al guardar en Sheets:", error));
    }

    function guardarPrestamoEnSesion(prestamo) {
      const prestamos = JSON.parse(sessionStorage.getItem("prestamos") || "[]");
      prestamos.push(prestamo);
      sessionStorage.setItem("prestamos", JSON.stringify(prestamos));
    }

    function mostrarPrestamosRegistrados() {
      const prestamos = JSON.parse(sessionStorage.getItem("prestamos") || "[]");
      const tbody = document.querySelector("#tablaPrestamos tbody");
      tbody.innerHTML = "";

      prestamos.forEach(p => {
        const row = `<tr><td>${p.responsable}</td><td>${p.alumno}</td><td>${p.libro}</td><td>${p.fecha}</td></tr>`;
        tbody.innerHTML += row;
      });
    }

    function buscarPrestamos() {
      const query = document.getElementById("buscarInput").value.toLowerCase();
      const url = "https://script.google.com/macros/s/AKfycbzPaECJsngiyD9uGGUzbbbXJ7URfcN4Is3zMquANdGwKCcb9uwAcK9BloA0M0dHVmg6cg/exec";

      fetch(url)
        .then(response => response.json())
        .then(data => {
          const tbody = document.querySelector("#tablaResultados tbody");
          tbody.innerHTML = "";
          data.forEach(p => {
            if (p.Alumno.toLowerCase().includes(query) || p.Libro.toLowerCase().includes(query)) {
              const row = `<tr><td>${p.Responsable}</td><td>${p.Alumno}</td><td>${p.Libro}</td><td>${p.Fecha}</td></tr>`;
              tbody.innerHTML += row;
            }
          });
        });
    }

    function cargarSesion() {
      const responsableGuardado = sessionStorage.getItem("responsableActual");
      if (responsableGuardado) {
        responsableActual = responsableGuardado;
        const respInput = document.getElementById("responsableInput");
        respInput.value = responsableActual;
        respInput.setAttribute("readonly", true);
        respInput.onclick = null;
      }
    }

    function cargarPrestamosDesdeSheets() {
      // Esta función puede usarse si querés cargar datos al iniciar. Por ahora queda vacía.
    }

    window.onload = () => {
      cargarSesion();
      cargarPrestamosDesdeSheets();
    };
  </script>
</body>
</html>

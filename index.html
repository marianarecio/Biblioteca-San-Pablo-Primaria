<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Biblioteca Primaria Colegio San Pablo</title>
  <link href="https://fonts.googleapis.com/css2?family=Jost&amp;display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Jost', sans-serif;
      background-color: #fff;
      color: #333;
      padding: 20px;
      text-align: center;
    }
    #top-image {
      display: block;
      margin: 0 auto 25px auto;
      max-height: 250px;
      width: auto;
    }
    h1 {
      font-size: 2.5em;
      color: #4a4e69;
      margin-bottom: 0.3em;
      margin-top: 0.1em;
    }
    #scanner {
      background: white;
      padding: 10px;
      border-radius: 12px;
      width: 320px;
      height: 320px;
      box-sizing: border-box;
    }
    /* Modal para el lector QR */
    #scannerModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    #scannerInner {
      position: relative;
    }
    #closeScannerBtn {
      position: absolute;
      top: -12px;
      right: -12px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #readerDiagnostics {
      margin-top: 8px;
      font-size: 0.9em;
      color: #333;
    }

    button {
      background-color: #a3c4f3;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      border-radius: 12px;
      cursor: pointer;
    }
    button:hover { background-color: #87b2f2; }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 600px;
      background-color: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th { background-color: #c9daf8; color: #333; }
    td { background-color: #fefefe; }
    input[type="text"] {
      padding: 10px;
      width: 80%;
      max-width: 400px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    #resultadosBusqueda {
      margin: 30px auto;
      max-width: 650px;
      text-align: left;
    }
    .search-label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
      margin-top: 18px;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .search-box { margin-bottom: 18px; }

    /* Banner de diagn√≥stico (visible si hay problemas de origen) */
    #diagBanner {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      padding: 10px;
      border-radius: 8px;
      max-width: 900px;
      margin: 10px auto;
    }

    @media (max-width: 600px) {
      body { padding: 8px; }
      #top-image { max-width: 90vw; max-height: 140px; }
      h1 { font-size: 1.5em; }
      table { font-size: 0.95em; width: 100%; max-width: 100vw; }
      input[type="text"] { width: 95vw; max-width: 98vw; font-size: 1em; }
      .search-label { max-width: 95vw; }
      button {
        width: 90vw; max-width: 95vw;
        margin-top: 8px; margin-bottom: 8px; font-size: 1.1em; display: block;
        margin-left: auto; margin-right: auto;
      }
      #scanner { width: 90vw; height: 60vh; max-height: 640px; }
    }
  </style>

  <!-- Librer√≠a HTML5 QR CODE (se especifica versi√≥n estable) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <img alt="Escudo Colegio San Pablo" id="top-image" src="https://csanpablo.edu.ar/wp-content/uploads/2022/07/escudo-centro-232x300.png"/>
  <h1>üìö Biblioteca Primaria Colegio San Pablo</h1>
  <p style="font-size:1em; color:#666; margin-bottom:14px;">Si est&aacute;s usando un celular, acepta el permiso de c&aacute;mara para escanear c&oacute;digos QR.</p>

  <div id="diagBanner" style="display:none;"></div>

  <p style="font-size: 1.1em; max-width: 98%; margin: 5px auto; line-height: 1.6;">
   Escane&aacute; primero el c&oacute;digo QR del <strong>responsable</strong>, luego el del <strong>alumno</strong> y por &uacute;ltimo el del <strong>libro</strong>.
  </p>

  <div>
   <input id="responsableInput" placeholder="Escane&aacute; el QR del responsable" readonly="True" type="text"/>
   <button onclick="startScanner('responsableInput')">üì∑</button>
   <input id="alumnoInput" placeholder="Escane&aacute; el QR del alumno" readonly="" type="text"/>
   <button onclick="startScanner('alumnoInput')">üì∑</button>
   <input id="libroInput" placeholder="Escane&aacute; el QR del libro" readonly="" type="text"/>
   <button onclick="startScanner('libroInput')">üì∑</button>
   <button onclick="registrarPrestamo()" style="background-color:#4a4e69;">Registrar Pr&eacute;stamo</button>
  </div>

  <h2 style="font-size: 2em; margin-top: 40px; margin-bottom: 20px;">üìã Pr&eacute;stamos Registrados</h2>
  <table>
   <thead>
    <tr>
     <th>Responsable</th>
     <th>Libro</th>
     <th>Alumno</th>
     <th>Fecha</th>
    </tr>
   </thead>
   <tbody id="prestamosTable"></tbody>
  </table>

  <div class="search-box">
   <h3>üîç Buscar informaci&oacute;n</h3>
   <label class="search-label" for="buscarLibro">Buscar por libro</label>
   <input id="buscarLibro" placeholder="Ej: LIB001 o t&iacute;tulo" type="text"/>
   <button onclick="startScanner('buscarLibro')">üì∑</button>
   <button onclick="buscarPorLibro()">Buscar</button>

   <label class="search-label" for="buscarAlumno">Buscar por alumno</label>
   <input id="buscarAlumno" placeholder="Ej: ALU001 o nombre" type="text"/>
   <button onclick="startScanner('buscarAlumno')">üì∑</button>
   <button onclick="buscarPorAlumno()">Buscar</button>
  </div>

  <div id="resultadosBusqueda"></div>

  <!-- Modal para lector QR -->
  <div id="scannerModal" aria-hidden="true">
    <div id="scannerInner">
      <button id="closeScannerBtn" title="Cerrar">&times;</button>
      <div id="scanner">
        <!-- Contenedor donde Html5QrcodeScanner renderizar√° la vista -->
        <div id="reader" style="width:100%; height:100%;"></div>
      </div>
      <div id="readerDiagnostics"></div>
    </div>
  </div>

<script>
  // Reemplaza esto con tu URL de Apps Script cuando subas.
  const SHEETS_WEBHOOK_URL = 'AQUI_TU_URL_DE_APPS_SCRIPT';

  let prestamos = [];

  function registrarPrestamo() {
    const responsable = document.getElementById('responsableInput').value.trim();
    const libro = document.getElementById('libroInput').value.trim();
    const alumno = document.getElementById('alumnoInput').value.trim();
    if (!responsable || !libro || !alumno) {
      alert("Escane√° primero el responsable, alumno y libro");
      return;
    }
    const fecha = new Date().toISOString().split('T')[0];
    prestamos.push({ responsable, libro, alumno, fecha });
    actualizarTabla();

    // Enviar a Google Sheets (puedes necesitar configurar CORS en tu Apps Script)
    fetch(SHEETS_WEBHOOK_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ responsable, libro, alumno, fecha })
    });

    document.getElementById('libroInput').value = "";
    document.getElementById('alumnoInput').value = "";
    alert("¬°Pr√©stamo registrado!");
  }

  function actualizarTabla() {
    const hoy = new Date().toISOString().split('T')[0];
    const tabla = document.getElementById("prestamosTable");
    tabla.innerHTML = "";
    prestamos
      .filter(p => p.fecha === hoy)
      .forEach(p => {
        const fila = tabla.insertRow();
        fila.insertCell(0).textContent = p.responsable;
        fila.insertCell(1).textContent = p.libro;
        fila.insertCell(2).textContent = p.alumno;
        fila.insertCell(3).textContent = p.fecha;
      });
  }

  function buscarPorLibro() {
    const consulta = document.getElementById("buscarLibro").value.toLowerCase();
    const resultados = prestamos.filter(p => p.libro.toLowerCase().includes(consulta));
    mostrarResultados("Libro", consulta, resultados);
  }

  function buscarPorAlumno() {
    const consulta = document.getElementById("buscarAlumno").value.toLowerCase();
    const resultados = prestamos.filter(p => p.alumno.toLowerCase().includes(consulta));
    mostrarResultados("Alumno", consulta, resultados);
  }

  function mostrarResultados(tipo, consulta, resultados) {
    const contenedor = document.getElementById("resultadosBusqueda");
    if (!consulta) { contenedor.innerHTML = ""; return; }
    if (resultados.length === 0) {
      contenedor.innerHTML = `<strong>No se encontraron resultados para ${tipo}: "${consulta}"</strong>`;
      return;
    }
    let html = `<strong>Resultados para ${tipo}: "${consulta}"</strong><ul>`;
    resultados.forEach(p => {
      html += `<li><strong>Libro:</strong> ${p.libro} | <strong>Alumno:</strong> ${p.alumno} | <strong>Fecha:</strong> ${p.fecha}</li>`;
    });
    html += "</ul>";
    contenedor.innerHTML = html;
  }

  // Manejo del lector QR con Html5QrcodeScanner (nivel alto)
  let html5QrcodeScanner = null;
  const modal = document.getElementById('scannerModal');
  const readerDiagnostics = document.getElementById('readerDiagnostics');
  const diagBanner = document.getElementById('diagBanner');

  // Mostrar banner de diagn√≥stico si el origen no es seguro o si se est√° abriendo por file://
  function checkSecureContext() {
    const proto = location.protocol;
    if (proto === 'file:') {
      diagBanner.style.display = 'block';
      diagBanner.innerHTML = '<strong>Atenci√≥n:</strong> Est√°s abriendo la p√°gina desde <code>file://</code>. La mayor√≠a de los navegadores bloquean el acceso a la c√°mara en p√°ginas abiertas desde archivos locales. <br>Para que la c√°mara funcione, serv√≠ la p√°gina desde <code>http://localhost:8000</code> o desde GitHub Pages (HTTPS).';
      return false;
    }
    if (proto !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      diagBanner.style.display = 'block';
      diagBanner.innerHTML = '<strong>Atenci√≥n:</strong> Esta p√°gina no est√° en un contexto seguro (HTTPS). El acceso a la c√°mara puede estar bloqueado. Para pruebas en tu PC us√° <code>http://localhost:8000</code> (considerado seguro). Para usar desde otros dispositivos, subila a GitHub Pages (HTTPS).';
      return false;
    }
    diagBanner.style.display = 'none';
    return true;
  }

  checkSecureContext();

  // Cerrar modal y detener scanner si est√° activo
  document.getElementById('closeScannerBtn').addEventListener('click', () => {
    if (html5QrcodeScanner) {
      // Html5QrcodeScanner no expone directamente clear() on the object returned by new Html5QrcodeScanner,
      // but it stores an internal Html5Qrcode instance; the library exposes a global method to clear the div.
      // We'll try to call clear on the rendered element by selecting the internal instance if exists.
      try {
        html5QrcodeScanner.clear().catch(()=>{});
      } catch(e) {
        // ignore
      }
      html5QrcodeScanner = null;
    }
    modal.style.display = 'none';
    readerDiagnostics.innerText = '';
  });

  function startScanner(inputId) {
    modal.style.display = 'flex';
    readerDiagnostics.innerText = 'Iniciando c√°mara...';

    // Si estamos en file:// mostramos mensaje y no intentamos abrir la c√°mara
    if (location.protocol === 'file:') {
      readerDiagnostics.innerHTML = 'No es posible acceder a la c√°mara desde <code>file://</code>. Ejecut√° un servidor local (ver instrucciones m√°s abajo) o sub√≠ la p√°gina a GitHub Pages.';
      return;
    }

    // Peque√±o retraso para que el modal se renderice en pantalla antes de iniciar la c√°mara
    setTimeout(() => {
      try {
        // Si ya existe un scanner intentar limpiar primero
        if (html5QrcodeScanner && typeof html5QrcodeScanner.clear === 'function') {
          html5QrcodeScanner.clear().catch(()=>{});
          html5QrcodeScanner = null;
          document.getElementById('reader').innerHTML = '';
        }
        // Crear y renderizar Html5QrcodeScanner
        html5QrcodeScanner = new Html5QrcodeScanner(
          "reader",
          { fps: 10, qrbox: { width: 250, height: 250 } },
          /* verbose= */ false
        );

        html5QrcodeScanner.render((decodedText, decodedResult) => {
          // √âxito: poner el texto en el input correspondiente
          document.getElementById(inputId).value = decodedText;
          readerDiagnostics.innerText = '¬°C√≥digo detectado!';
          // detener y cerrar
          try {
            html5QrcodeScanner.clear().then(() => {
              modal.style.display = 'none';
              html5QrcodeScanner = null;
              readerDiagnostics.innerText = '';
            }).catch(()=> {
              modal.style.display = 'none';
              html5QrcodeScanner = null;
              readerDiagnostics.innerText = '';
            });
          } catch(e) {
            modal.style.display = 'none';
            html5QrcodeScanner = null;
            readerDiagnostics.innerText = '';
          }
        }, (errorMessage) => {
          // errores durante el escaneo (no cr√≠ticos)
          readerDiagnostics.innerText = 'Escaneando...';
        });
      } catch (err) {
        readerDiagnostics.innerText = 'Error al iniciar Html5Qrcode: ' + (err && err.message ? err.message : err);
      }
    }, 200);
  }

  // Consejos r√°pidos para ejecutar servidor local:
  // - Python 3: en la carpeta del proyecto ejecut√°: python -m http.server 8000
  //   y abr√≠ en el navegador: http://localhost:8000/index_qr_fix_final.html
  // - Node (temporal): npx http-server -p 8000
  // - VSCode: instalar Live Server y dar "Open with Live Server"
  // - Para usar desde el celular desde otra red: sub√≠ el repo a GitHub y activ√° GitHub Pages (HTTPS)
  //
  // Mensaje adicional si la c√°mara no arranca: asegurate de aceptar el permiso de c√°mara en el navegador
  // (ver icono de c√°mara en la barra de direcciones o configuraci√≥n del sitio).

  // Revisar contexto al cargar (por si el usuario abre y necesita instrucciones)
  window.addEventListener('load', () => {
    checkSecureContext();
  });

</script>
</body>
</html>
